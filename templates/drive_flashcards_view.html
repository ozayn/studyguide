<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flashcards</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1a30;
      --text: #eaf0ff;
      --muted: rgba(234,240,255,0.7);
      --border: rgba(255,255,255,0.12);
      --btn: rgba(255,255,255,0.10);
      --btn2: rgba(255,255,255,0.16);
      --accent: #7c3aed;
    }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .topbar { position: sticky; top: 0; z-index: 10; background: rgba(11,18,32,0.92); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); }
    .topbar-inner { max-width: 980px; margin: 0 auto; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .title { font-weight: 700; }
    .meta { color: var(--muted); font-size: 12px; }
    .btn { appearance: none; border: 1px solid var(--border); background: var(--btn); color: var(--text); padding: 8px 10px; border-radius: 10px; cursor: pointer; font-size: 13px; }
    .btn:hover { background: var(--btn2); }
    .btn.primary { background: rgba(124,58,237,0.25); border-color: rgba(124,58,237,0.55); }
    .btn.primary:hover { background: rgba(124,58,237,0.35); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px 16px 40px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      min-height: 240px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
    .q { font-size: 18px; line-height: 1.35; font-weight: 650; }
    .a { font-size: 16px; line-height: 1.5; color: rgba(234,240,255,0.92); white-space: pre-wrap; }
    .ev { font-size: 13px; line-height: 1.45; color: rgba(234,240,255,0.72); white-space: pre-wrap; border-left: 3px solid rgba(124,58,237,0.55); padding-left: 10px; margin-top: 8px; }
    .footer { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    .pill { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 4px 8px; border-radius: 999px; display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 999px; display: inline-block; flex: 0 0 8px; }
    .chip { font-size: 12px; color: rgba(234,240,255,0.92); border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); padding: 4px 8px; border-radius: 999px; display: inline-flex; align-items: center; gap: 6px; }
    .chip.muted { color: var(--muted); }
    .chips { display: inline-flex; gap: 6px; flex-wrap: wrap; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    @media print { .topbar { display: none; } body { background: white; color: black; } .card { background: none; border: 1px solid #ddd; } }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="title">Flashcards</div>
        <div class="meta" id="meta"></div>
      </div>
      <div class="controls">
        <button class="btn" onclick="shuffleDeck()">Shuffle</button>
        <button class="btn" onclick="downloadCSV()">Download CSV</button>
        <button class="btn" onclick="window.print()">Print</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card" id="card" onclick="toggleAnswer()" role="button" aria-label="Flashcard">
      <div class="label" id="label">Question</div>
      <div class="q" id="q">Loading…</div>
      <div class="a" id="a" style="display:none;"></div>
      <div class="ev" id="ev" style="display:none;"></div>
      <div class="footer">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <span class="pill" id="pos">0 / 0</span>
          <span class="pill" id="level"></span>
          <span class="chips" id="source"></span>
        </div>
        <div class="controls">
          <button class="btn" onclick="prevCard(event)">Prev</button>
          <button class="btn primary" onclick="toggleAnswer(event)">Flip</button>
          <button class="btn" onclick="nextCard(event)">Next</button>
        </div>
      </div>
    </div>
  </div>

  <script type="application/json" id="deck-json">{{ deck|tojson }}</script>
  <script>
    const DECK = JSON.parse(document.getElementById('deck-json')?.textContent || '{}');
    const cards = Array.isArray(DECK.cards) ? DECK.cards.slice() : [];
    let idx = 0;
    let showA = false;

    document.getElementById('meta').textContent =
      `Folder: ${DECK.folder_id || '—'} • Kind: ${DECK.kind || '—'} • Generated: ${DECK.created_at || '—'} • Cards: ${cards.length}`;

    function compactSource(s) {
      let v = String(s || '').trim();
      if (!v) return '';
      // Remove common noisy prefixes
      v = v.replace(/^My Drive\s*\/\s*/i, '');
      v = v.replace(/^AI Course\s*\/\s*/i, '');
      v = v.replace(/^AIML\s*Course\s*\/\s*/i, '');
      // If still very deep, keep only the last 3 segments for readability
      const parts = v.split('/').map(x => x.trim()).filter(Boolean);
      if (parts.length > 3) v = parts.slice(parts.length - 3).join(' / ');
      return v;
    }

    function hueFromString(str) {
      const s = String(str || '');
      let h = 0;
      for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
      return h % 360;
    }

    function renderSourceChips(source) {
      const el = document.getElementById('source');
      if (!el) return;
      el.innerHTML = '';
      const s = compactSource(source);
      if (!s) return;

      // Split on "/" and also " / " (we normalize to "/")
      const parts = s.split('/').map(x => x.trim()).filter(Boolean);
      const file = parts.length ? parts[parts.length - 1] : s;
      const parent = parts.length >= 2 ? parts[parts.length - 2] : '';
      const category = parts.length >= 3 ? parts[parts.length - 3] : (parent || 'Source');
      const hue = hueFromString(category);
      const dotColor = `hsl(${hue} 80% 60%)`;

      const catChip = document.createElement('span');
      catChip.className = 'chip';
      const dot = document.createElement('span');
      dot.className = 'dot';
      dot.style.background = dotColor;
      const catText = document.createElement('span');
      catText.textContent = category;
      catChip.appendChild(dot);
      catChip.appendChild(catText);

      el.appendChild(catChip);

      if (parent && parent !== category) {
        const parentChip = document.createElement('span');
        parentChip.className = 'chip muted';
        parentChip.textContent = parent;
        el.appendChild(parentChip);
      }

      if (file) {
        const fileChip = document.createElement('span');
        fileChip.className = 'chip muted';
        fileChip.textContent = file;
        el.appendChild(fileChip);
      }
    }

    function render() {
      const c = cards[idx] || {};
      document.getElementById('q').textContent = c.q || '(no question)';
      document.getElementById('a').textContent = c.a || '';
      document.getElementById('ev').textContent = c.evidence ? `Evidence: ${c.evidence}` : '';
      document.getElementById('pos').textContent = `${cards.length ? (idx + 1) : 0} / ${cards.length}`;
      document.getElementById('level').textContent = c.level ? `Level: ${c.level}` : '';
      renderSourceChips(c.source || '');
      document.getElementById('a').style.display = showA ? 'block' : 'none';
      document.getElementById('ev').style.display = (showA && c.evidence) ? 'block' : 'none';
      document.getElementById('label').textContent = showA ? 'Answer' : 'Question';
    }

    function toggleAnswer(ev) {
      if (ev) ev.stopPropagation();
      showA = !showA;
      render();
    }
    function nextCard(ev) {
      if (ev) ev.stopPropagation();
      if (!cards.length) return;
      idx = (idx + 1) % cards.length;
      showA = false;
      render();
    }
    function prevCard(ev) {
      if (ev) ev.stopPropagation();
      if (!cards.length) return;
      idx = (idx - 1 + cards.length) % cards.length;
      showA = false;
      render();
    }
    function shuffleDeck() {
      for (let i = cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cards[i], cards[j]] = [cards[j], cards[i]];
      }
      idx = 0;
      showA = false;
      render();
    }

    function csvEscape(s) {
      const v = String(s ?? '');
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
      return v;
    }

    function downloadCSV() {
      const header = ['Question','Answer','Level','Source'];
      const lines = [header.join(',')];
      for (const c of cards) {
        lines.push([
          csvEscape(c.q),
          csvEscape(c.a),
          csvEscape(c.level),
          csvEscape(c.source)
        ].join(','));
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'flashcards.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    render();
  </script>
</body>
</html>

