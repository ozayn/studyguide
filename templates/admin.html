<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - My Study Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafafa;
            --surface: #ffffff;
            --text: #1a1a1a;
            --text-light: #666666;
            --border: #e0e0e0;
            --accent: #ff8c42;
            --accent-light: #ffa366;
            --success: #10b981;
            --danger: #ef4444;
            --bg-hover: #f5f5f5;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .back-link {
            color: var(--text);
            text-decoration: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 16px;
            transition: opacity 0.2s;
        }

        .back-link:hover {
            opacity: 0.7;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .user-name {
            color: var(--text);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .auth-status {
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .auth-status.local {
            color: #f59e0b;
        }

        .auth-status.authenticated {
            color: var(--success);
        }

        .auth-status.required {
            color: var(--danger);
        }

        .logout-link {
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .logout-link:hover {
            color: var(--text);
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin: 0;
            color: var(--text);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8125rem;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .category-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .subcategory-section {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .subcategory-content.hidden {
            display: none !important;
        }

        .hidden {
            display: none !important;
        }

        .subcategory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-light);
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            line-height: 1;
        }

        .toggle-btn:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .subcategory-content {
            margin-top: 12px;
        }

        .subcategory-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .topics-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .topic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .topic-item:hover {
            background: var(--bg-hover);
        }

        .topic-name {
            flex: 1;
            font-size: 0.9375rem;
            min-width: 300px;
        }

        .topic-actions {
            display: flex;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
            background: var(--surface);
            color: var(--text);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .add-category-form, .add-topic-form {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .form-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .form-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.875rem;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 24px;
        }

        .back-link:hover {
            color: var(--text);
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            .category-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .form-row {
                flex-direction: column;
            }

            .topic-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .topic-actions {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Study Guide</a>
        
        <div class="header">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div>
                    <h1>Topics Admin</h1>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 24px;">
                <button class="btn btn-primary" onclick="saveAll()">üíæ Save All Changes</button>
                <div class="user-info">
                    <div class="user-name">
                        {% if session and session.get('user_name') %}
                            {{ session.user_name }}
                        {% elif session and session.get('user_email') %}
                            {{ session.user_email }}
                        {% else %}
                            Local Development
                        {% endif %}
                    </div>
                    {% if request.host.startswith('localhost') or request.host.startswith('127.0.0.1') or request.host.startswith('10.') %}
                    <div class="auth-status local">Local Development</div>
                    {% elif session and session.get('user_email') %}
                    <div class="auth-status authenticated">Authenticated</div>
                    {% else %}
                    <div class="auth-status required">Authentication Required</div>
                    {% endif %}
                    {% if session and session.get('user_email') %}
                    <a href="/auth/logout" class="logout-link">Logout</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="message"></div>

        <div class="card" style="margin-bottom: 24px;">
            <h2 style="margin-top: 0; margin-bottom: 16px;">AI Settings</h2>
            <div class="form-row">
                <div class="input-group">
                    <label for="flashcards-count">Flashcards per topic</label>
                    <input type="number" id="flashcards-count" min="5" max="40" step="1" placeholder="15">
                    <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 6px;">
                        Used when generating üìù Study Notes (Cards are derived from these).
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>

        {% if drive_enabled %}
        <div class="card" style="margin-bottom: 24px;">
            <h2 style="margin-top: 0; margin-bottom: 8px;">Google Drive (PDF + .ipynb)</h2>
            <div style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 14px;">
                Connect Drive, index a folder, then extract topics from <strong>PDF</strong> and <strong>.ipynb</strong> files (incremental; safe for large folders).
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 12px;">
                <button class="btn btn-secondary" type="button" onclick="connectDrive()">üîê Connect Drive</button>
                <div id="drive-status" style="font-size: 0.85rem; color: var(--text-light);">Checking Drive status‚Ä¶</div>
            </div>

            <div class="form-row" style="margin-top: 8px;">
                <div class="input-group" style="flex: 1;">
                    <label for="drive-folder-id">Drive Folder ID</label>
                    <input type="text" id="drive-folder-id" placeholder="e.g. 1a2B3cD4eF... (from Drive URL)">
                    <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 6px;">
                        Tip: open the folder in Drive and copy the ID from the URL (between <code>/folders/</code> and <code>?</code>).
                    </div>
                </div>
                <button class="btn btn-primary" type="button" onclick="driveRunAllDSMid()" id="drive-run-all-btn">Run: Index ‚Üí Extract ‚Üí Generate DS Guide</button>
                <button class="btn btn-secondary" type="button" onclick="driveOpenDSMidGuide()" id="drive-open-ds-btn">Open DS Guide</button>
            </div>

            <details style="margin-top: 12px;">
                <summary style="cursor:pointer; color: var(--text-light); font-size: 0.9rem;">Advanced</summary>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;">
                    <button class="btn btn-secondary" type="button" onclick="driveIndex()">Index Folder</button>
                    <button class="btn btn-secondary" type="button" onclick="driveExtractTopics()">Extract Topics (1 batch)</button>
                    <button class="btn btn-secondary" type="button" onclick="driveGenerateGuide()">Generate Concise (Course) Guide</button>
                    <button class="btn btn-secondary" type="button" onclick="driveOpenGuide()">Open Concise (Course) Guide</button>
                    <button class="btn btn-secondary" type="button" onclick="driveGenerateDSMidGuide()">Generate DS (Mid) Guide</button>
                        <button class="btn btn-secondary" type="button" onclick="driveGenerateFlashcards()">Generate Flashcards (from files)</button>
                        <button class="btn btn-secondary" type="button" onclick="driveOpenFlashcards()">Open Flashcards</button>
                </div>
            </details>

            <div id="drive-output" style="margin-top: 14px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: #111;"></div>
        </div>
        {% endif %}

        <div id="categories-container"></div>

        <div class="card">
            <h2 style="margin-top: 0; margin-bottom: 16px;">Add New Category</h2>
            <div class="add-category-form">
                <div class="form-row">
                    <div class="input-group">
                        <label for="new-category-name">Category Name</label>
                        <input type="text" id="new-category-name" placeholder="e.g., Data Structures">
                    </div>
                    <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let topicsData = { categories: [], uncategorized_topics: [] };
        let adminSettings = { flashcards_count: 15 };

        async function loadSettings() {
            try {
                const response = await fetch('/api/admin/settings');
                adminSettings = await response.json();
                const el = document.getElementById('flashcards-count');
                if (el && adminSettings && typeof adminSettings.flashcards_count !== 'undefined') {
                    el.value = adminSettings.flashcards_count;
                }
            } catch (error) {
                // Non-fatal
                console.warn('Error loading settings:', error);
            }
        }

        async function saveSettings() {
            try {
                const el = document.getElementById('flashcards-count');
                const flashcards_count = el ? parseInt(el.value || '15', 10) : 15;
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ flashcards_count })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to save settings');
                showMessage('‚úÖ Settings saved!', 'success');
            } catch (error) {
                showMessage('Error saving settings: ' + error.message, 'error');
            }
        }

        async function loadTopics() {
            try {
                const response = await fetch('/api/topics');
                topicsData = await response.json();
                renderCategories();
            } catch (error) {
                showMessage('Error loading topics: ' + error.message, 'error');
            }
        }

        {% if drive_enabled %}
        function setDriveOutput(obj) {
            const el = document.getElementById('drive-output');
            if (!el) return;
            try {
                el.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
            } catch (e) {
                el.textContent = String(obj);
            }
        }

        async function refreshDriveStatus() {
            const el = document.getElementById('drive-status');
            if (!el) return;
            try {
                const res = await fetch('/api/drive/status');
                if (res.ok) {
                    const data = await res.json();
                    el.textContent = `Connected as ${data.email || 'unknown'}`;
                    el.style.color = 'var(--success)';
                } else {
                    const data = await res.json().catch(() => ({}));
                    el.textContent = 'Not connected';
                    el.style.color = 'var(--text-light)';
                    if (data && data.auth_url) {
                        // keep auth_url available via output
                        setDriveOutput({ hint: 'Click ‚ÄúConnect Drive‚Äù to authorize.', auth_url: data.auth_url });
                    }
                }
            } catch (e) {
                el.textContent = 'Drive status unavailable';
                el.style.color = 'var(--danger)';
            }
        }

        function connectDrive() {
            // This will request drive.readonly scope (works even on localhost now).
            window.location.href = '/auth/login?drive=1';
        }

        async function driveIndex() {
            const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
            if (!folderId) {
                showMessage('Please paste a Drive folder ID first', 'error');
                return;
            }
            setDriveOutput('Indexing‚Ä¶');
            try {
                const res = await fetch('/api/drive/index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_id: folderId })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Index failed');
                setDriveOutput(data);
                showMessage(`‚úÖ Indexed ${data.indexed} files`, 'success');
            } catch (e) {
                setDriveOutput({ error: e.message || String(e) });
                showMessage('Drive index error: ' + (e.message || e), 'error');
            }
            refreshDriveStatus();
        }

        async function driveExtractTopics() {
            setDriveOutput('Extracting topics‚Ä¶');
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const res = await fetch('/api/drive/extract-topics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: 10, force: false, folder_id: folderId })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Extract failed');
                setDriveOutput(data);
                showMessage(`‚úÖ Extracted topics from ${data.count} files`, 'success');
            } catch (e) {
                setDriveOutput({ error: e.message || String(e) });
                showMessage('Drive extract error: ' + (e.message || e), 'error');
            }
            refreshDriveStatus();
        }

        async function driveGenerateGuide() {
            setDriveOutput('Generating concise guide‚Ä¶ (this can take 30‚Äì90s)');
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const res = await fetch('/api/drive/guide/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kind: 'concise', max_topics: 160, folder_id: folderId })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Guide generation failed');
                setDriveOutput(data);
                showMessage('‚úÖ Guide generated!', 'success');
            } catch (e) {
                setDriveOutput({ error: e.message || String(e) });
                showMessage('Guide generation error: ' + (e.message || e), 'error');
            }
        }

        async function driveOpenGuide() {
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const qs = folderId ? `?folder_id=${encodeURIComponent(folderId)}` : '';
                window.open(`/drive/guide/view/latest${qs}`, '_blank');
            } catch (e) {
                showMessage('Open guide error: ' + (e.message || e), 'error');
            }
        }

        async function driveGenerateDSMidGuide() {
            setDriveOutput('Generating DS (mid) interview guide‚Ä¶ (this can take 45‚Äì120s)');
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const res = await fetch('/api/drive/guide/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kind: 'ds_mid', max_topics: 200, folder_id: folderId })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Guide generation failed');
                setDriveOutput(data);
                showMessage('‚úÖ DS guide generated!', 'success');
            } catch (e) {
                setDriveOutput({ error: e.message || String(e) });
                showMessage('DS guide generation error: ' + (e.message || e), 'error');
            }
        }

        function driveOpenDSMidGuide() {
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const qs = new URLSearchParams();
                qs.set('kind', 'ds_mid');
                if (folderId) qs.set('folder_id', folderId);
                window.open(`/drive/guide/view/latest?${qs.toString()}`, '_blank');
            } catch (e) {
                showMessage('Open DS guide error: ' + (e.message || e), 'error');
            }
        }

        async function driveGenerateFlashcards() {
            setDriveOutput('Generating flashcards‚Ä¶ (this can take 30‚Äì120s depending on files)');
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const res = await fetch('/api/drive/flashcards/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kind: 'ds_mid', folder_id: folderId, limit_files: 6, cards_per_file: 8, max_total: 120 })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Flashcard generation failed');
                setDriveOutput(data);
                showMessage(`‚úÖ Generated ${data.card_count} flashcards`, 'success');
                return data;
            } catch (e) {
                setDriveOutput({ error: e.message || String(e) });
                showMessage('Flashcard generation error: ' + (e.message || e), 'error');
                return null;
            }
        }

        async function driveOpenFlashcards() {
            try {
                const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
                const qs = new URLSearchParams();
                qs.set('kind', 'ds_mid');
                if (folderId) qs.set('folder_id', folderId);
                // If there's no deck yet, auto-generate then open (smoother flow).
                const check = await fetch(`/api/drive/flashcards/latest?${qs.toString()}`);
                if (!check.ok) {
                    const generated = await driveGenerateFlashcards();
                    if (!generated) return;
                }
                window.open(`/drive/flashcards/view/latest?${qs.toString()}`, '_blank');
            } catch (e) {
                showMessage('Open flashcards error: ' + (e.message || e), 'error');
            }
        }

        function setDriveBusy(isBusy, label) {
            const runBtn = document.getElementById('drive-run-all-btn');
            const openBtn = document.getElementById('drive-open-ds-btn');
            if (runBtn) {
                runBtn.disabled = !!isBusy;
                runBtn.textContent = isBusy ? (label || 'Working‚Ä¶') : 'Run: Index ‚Üí Extract ‚Üí Generate DS Guide';
            }
            if (openBtn) openBtn.disabled = !!isBusy;
        }

        async function driveRunAllDSMid() {
            const folderId = (document.getElementById('drive-folder-id')?.value || '').trim();
            if (!folderId) {
                showMessage('Please paste a Drive folder ID first', 'error');
                return;
            }

            setDriveBusy(true, 'Checking auth‚Ä¶');
            try {
                // Ensure Drive is connected; if not, redirect to auth.
                const st = await fetch('/api/drive/status');
                if (!st.ok) {
                    const data = await st.json().catch(() => ({}));
                    if (data && data.auth_url) {
                        setDriveBusy(false);
                        window.location.href = data.auth_url;
                        return;
                    }
                    throw new Error(data.error || 'Drive not connected');
                }

                // 1) Index
                setDriveBusy(true, 'Indexing‚Ä¶');
                setDriveOutput('Indexing folder‚Ä¶');
                let res = await fetch('/api/drive/index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_id: folderId })
                });
                let data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Index failed');
                setDriveOutput(data);

                // 2) Extract in batches
                const maxBatches = 8; // ~80 files per run
                for (let i = 0; i < maxBatches; i++) {
                    setDriveBusy(true, `Extracting‚Ä¶ (${i + 1}/${maxBatches})`);
                    res = await fetch('/api/drive/extract-topics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ limit: 10, force: false, folder_id: folderId })
                    });
                    data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Extract failed');
                    setDriveOutput(data);
                    // Stop early when nothing left to process.
                    if (!data || !data.count) break;
                    // Small pause so UI updates feel responsive.
                    await new Promise(r => setTimeout(r, 250));
                }

                // 3) Generate DS guide
                setDriveBusy(true, 'Generating DS guide‚Ä¶');
                setDriveOutput('Generating DS (mid) interview guide‚Ä¶');
                res = await fetch('/api/drive/guide/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kind: 'ds_mid', max_topics: 220, folder_id: folderId })
                });
                data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Guide generation failed');
                setDriveOutput(data);
                showMessage('‚úÖ DS guide generated!', 'success');

            } catch (e) {
                setDriveOutput({ error: e.message || String(e) });
                showMessage('Run failed: ' + (e.message || e), 'error');
            } finally {
                setDriveBusy(false);
                refreshDriveStatus();
            }
        }
        {% endif %}

        // Initialize
        loadSettings();
        loadTopics();
        {% if drive_enabled %}
        refreshDriveStatus();
        {% endif %}

        // Recursive function to render a node (category/subcategory) at any depth
        function renderNode(node, path, depth = 0) {
            const nodeIndex = path[path.length - 1];
            const pathString = path.join('-');
            const hasSubcategories = node.subcategories && node.subcategories.length > 0;
            const hasDirectTopics = node.topics && node.topics.length > 0;
            
            let html = '';
            const indent = depth * 20;
            const fontSize = Math.max(0.875, 1 - (depth * 0.05));
            
            // Render subcategories recursively
            let subcategoriesHtml = '';
            if (hasSubcategories) {
                node.subcategories.forEach((subcat, subcatIndex) => {
                    const newPath = [...path, subcatIndex];
                    subcategoriesHtml += renderNode(subcat, newPath, depth + 1);
                });
            }
            
            // Render direct topics
            let topicsHtml = '';
            if (hasDirectTopics) {
                node.topics.forEach((topic, topicIndex) => {
                    const topicPathString = [...path, 'topic', topicIndex].join('-');
                    topicsHtml += `
                        <li class="topic-item">
                            <input type="text" class="topic-name" value="${topic}" 
                                   onchange="updateTopicByPath([${path.join(',')}], ${topicIndex}, this.value)"
                                   style="border: none; background: transparent; flex: 1; padding: 0;">
                            <div class="topic-actions">
                                <button class="btn btn-danger btn-small" onclick="deleteTopicByPath([${path.join(',')}], ${topicIndex})">√ó</button>
                            </div>
                        </li>
                    `;
                });
            }
            
            // Check if there's any content to toggle
            // Always show toggle button for subcategories, even if empty (so they look consistent)
            const hasContent = hasSubcategories || hasDirectTopics;
            const showToggle = hasContent || depth > 0; // Show toggle for all subcategories (depth > 0) or if they have content
            
            // Build the node HTML
            const sectionId = `section-${pathString}`;
            html += `
                <div class="subcategory-section" style="margin-left: ${indent}px; ${depth > 0 ? 'border-left: 2px solid var(--border); padding-left: 16px;' : ''}">
                    <div class="subcategory-header">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            ${showToggle ? `<button class="toggle-btn" onclick="toggleSection('${sectionId}')" title="Toggle section">${hasContent ? '‚ñº' : '‚ñ∂'}</button>` : '<span style="width: 24px;"></span>'}
                            <input type="text" class="subcategory-title" value="${node.name}" 
                                   onchange="updateNodeNameByPath([${path.join(',')}], this.value)"
                                   style="border: none; background: transparent; font-size: ${fontSize}rem; font-weight: 600; padding: 0; width: 100%; max-width: ${600 - depth * 50}px;">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-small" onclick="addSubcategoryByPath([${path.join(',')}])">+ Add Subcategory</button>
                            <button class="btn btn-secondary btn-small" onclick="addTopicByPath([${path.join(',')}])">+ Add Topic</button>
                            ${depth > 0 ? `<button class="btn btn-danger btn-small" onclick="deleteNodeByPath([${path.join(',')}])">Delete</button>` : ''}
                        </div>
                    </div>
                    <div class="subcategory-content ${hasContent ? '' : 'hidden'}" id="${sectionId}">
                        ${subcategoriesHtml}
                        ${hasDirectTopics ? `<ul class="topics-list">${topicsHtml}</ul>` : ''}
                        <div class="add-topic-form">
                            <div class="form-row">
                                <div class="input-group">
                                    <input type="text" id="new-topic-${pathString}" placeholder="Add new topic..." 
                                           onkeypress="if(event.key==='Enter') addTopicByPath([${path.join(',')}])">
                                </div>
                                <button class="btn btn-secondary btn-small" onclick="addTopicByPath([${path.join(',')}])">Add Topic</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            topicsData.categories.forEach((category, catIndex) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const hasSubcategories = category.subcategories && category.subcategories.length > 0;
                const hasDirectTopics = category.topics && category.topics.length > 0;
                
                let subcategoriesContainer = '';
                if (hasSubcategories) {
                    category.subcategories.forEach((subcat, subcatIndex) => {
                        subcategoriesContainer += renderNode(subcat, [catIndex, subcatIndex], 0);
                    });
                }
                
                // Render direct topics if they exist
                let directTopicsHtml = '';
                if (hasDirectTopics) {
                    category.topics.forEach((topic, topicIndex) => {
                        directTopicsHtml += `
                            <li class="topic-item">
                                <input type="text" class="topic-name" value="${topic}" 
                                       onchange="updateTopicByPath([${catIndex}], ${topicIndex}, this.value)"
                                       style="border: none; background: transparent; flex: 1; padding: 0;">
                                <div class="topic-actions">
                                    <button class="btn btn-danger btn-small" onclick="deleteTopicByPath([${catIndex}], ${topicIndex})">√ó</button>
                                </div>
                            </li>
                        `;
                    });
                }
                
                const categorySectionId = `category-section-${catIndex}`;
                const categoryHasContent = hasSubcategories || hasDirectTopics;
                
                card.innerHTML = `
                    <div class="category-header">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            ${categoryHasContent ? `<button class="toggle-btn" onclick="toggleSection('${categorySectionId}')" title="Toggle category">‚ñº</button>` : '<span style="width: 24px;"></span>'}
                            <input type="text" class="category-title" value="${category.name}" 
                                   onchange="updateCategoryName(${catIndex}, this.value)"
                                   style="border: none; background: transparent; font-size: 1.25rem; font-weight: 600; padding: 0; width: 100%; max-width: 800px;">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-small" onclick="addSubcategory(${catIndex})">+ Add Subcategory</button>
                            <button class="btn btn-secondary btn-small" onclick="addTopicByPath([${catIndex}])">+ Add Topic</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCategory(${catIndex})">Delete Category</button>
                        </div>
                    </div>
                    <div class="subcategory-content ${categoryHasContent ? '' : 'hidden'}" id="${categorySectionId}">
                        ${subcategoriesContainer}
                        ${hasDirectTopics ? `
                            <div class="subcategory-section" style="margin-top: ${hasSubcategories ? '20' : '0'}px;">
                                <div class="subcategory-header" style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                                    <div style="font-size: 0.9375rem; font-weight: 600; color: var(--text);">Topics</div>
                                </div>
                                <ul class="topics-list">${directTopicsHtml}</ul>
                                <div class="add-topic-form">
                                    <div class="form-row">
                                        <div class="input-group">
                                            <input type="text" id="new-topic-${catIndex}" placeholder="Add new topic..." 
                                                   onkeypress="if(event.key==='Enter') addTopicByPath([${catIndex}])">
                                        </div>
                                        <button class="btn btn-secondary btn-small" onclick="addTopicByPath([${catIndex}])">Add Topic</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        ${!hasDirectTopics ? `
                            <div class="add-topic-form">
                                <div class="form-row">
                                    <div class="input-group">
                                        <input type="text" id="new-topic-${catIndex}" placeholder="Add new topic..." 
                                               onkeypress="if(event.key==='Enter') addTopicByPath([${catIndex}])">
                                    </div>
                                    <button class="btn btn-secondary btn-small" onclick="addTopicByPath([${catIndex}])">Add Topic</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function addCategory() {
            const nameInput = document.getElementById('new-category-name');
            const name = nameInput.value.trim();
            if (!name) {
                showMessage('Please enter a category name', 'error');
                return;
            }
            topicsData.categories.push({ name, subcategories: [] });
            nameInput.value = '';
            renderCategories();
            showMessage('Category added. Don\'t forget to save!', 'success');
        }

        function updateCategoryName(catIndex, newName) {
            topicsData.categories[catIndex].name = newName.trim();
        }

        function deleteCategory(catIndex) {
            if (confirm(`Delete category "${topicsData.categories[catIndex].name}" and all its subcategories and topics?`)) {
                topicsData.categories.splice(catIndex, 1);
                renderCategories();
                showMessage('Category deleted. Don\'t forget to save!', 'success');
            }
        }

        function addSubcategory(catIndex) {
            const name = prompt('Enter subcategory name:');
            if (!name || !name.trim()) {
                return;
            }
            if (!topicsData.categories[catIndex].subcategories) {
                topicsData.categories[catIndex].subcategories = [];
            }
            topicsData.categories[catIndex].subcategories.push({ name: name.trim(), topics: [] });
            renderCategories();
            // Show the category content section if it was hidden
            const categorySectionId = `category-section-${catIndex}`;
            const categoryContentSection = document.getElementById(categorySectionId);
            if (categoryContentSection) {
                categoryContentSection.classList.remove('hidden');
            }
            showMessage('Subcategory added. Don\'t forget to save!', 'success');
        }

        // Helper function to get node by path
        function getNodeByPath(path) {
            let node = topicsData.categories[path[0]];
            for (let i = 1; i < path.length; i++) {
                if (!node.subcategories) node.subcategories = [];
                node = node.subcategories[path[i]];
            }
            return node;
        }

        // Helper function to get parent node by path
        function getParentNodeByPath(path) {
            if (path.length <= 1) return topicsData.categories;
            let node = topicsData.categories[path[0]];
            for (let i = 1; i < path.length - 1; i++) {
                if (!node.subcategories) node.subcategories = [];
                node = node.subcategories[path[i]];
            }
            return node.subcategories;
        }

        function addSubcategoryByPath(path) {
            const name = prompt('Enter subcategory name:');
            if (!name || !name.trim()) {
                return;
            }
            const node = getNodeByPath(path);
            if (!node.subcategories) node.subcategories = [];
            node.subcategories.push({ name: name.trim(), topics: [] });
            renderCategories();
            // Show the content section if it was hidden
            const pathString = path.join('-');
            const sectionId = `section-${pathString}`;
            const contentSection = document.getElementById(sectionId);
            if (contentSection) {
                contentSection.classList.remove('hidden');
            }
            showMessage('Subcategory added. Don\'t forget to save!', 'success');
        }

        function addTopicByPath(path) {
            const pathString = path.join('-');
            const input = document.getElementById(`new-topic-${pathString}`);
            const topic = input ? input.value.trim() : '';
            if (!topic) {
                showMessage('Please enter a topic name', 'error');
                return;
            }
            const node = getNodeByPath(path);
            if (!node.topics) node.topics = [];
            node.topics.push(topic);
            if (input) input.value = '';
            renderCategories();
            // Show the content section if it was hidden
            const sectionId = `section-${pathString}`;
            const contentSection = document.getElementById(sectionId);
            if (contentSection) {
                contentSection.classList.remove('hidden');
            }
            // Also show parent category content if adding to a category
            if (path.length === 1) {
                const categorySectionId = `category-section-${path[0]}`;
                const categoryContentSection = document.getElementById(categorySectionId);
                if (categoryContentSection) {
                    categoryContentSection.classList.remove('hidden');
                }
            }
            showMessage('Topic added. Don\'t forget to save!', 'success');
        }

        function updateNodeNameByPath(path, newName) {
            const node = getNodeByPath(path);
            node.name = newName.trim();
        }

        function updateTopicByPath(path, topicIndex, newValue) {
            const node = getNodeByPath(path);
            if (!node.topics) node.topics = [];
            node.topics[topicIndex] = newValue.trim();
        }

        function deleteNodeByPath(path) {
            const node = getNodeByPath(path);
            if (confirm(`Delete "${node.name}" and all its subcategories and topics?`)) {
                const parent = getParentNodeByPath(path);
                parent.splice(path[path.length - 1], 1);
                renderCategories();
                showMessage('Deleted. Don\'t forget to save!', 'success');
            }
        }

        function deleteTopicByPath(path, topicIndex) {
            const node = getNodeByPath(path);
            const topic = node.topics[topicIndex];
            if (confirm(`Delete topic "${topic}"?`)) {
                node.topics.splice(topicIndex, 1);
                renderCategories();
                showMessage('Topic deleted. Don\'t forget to save!', 'success');
            }
        }

        function toggleSection(sectionId) {
            const contentSection = document.getElementById(sectionId);
            if (!contentSection) return;
            
            // Find the toggle button - it could be in a category-header or subcategory-header
            const card = contentSection.closest('.card, .subcategory-section');
            if (!card) return;
            
            // Toggle the collapsed class on the content section
            contentSection.classList.toggle('hidden');
            
            // Find and update the toggle button
            const toggleBtn = card.querySelector('.toggle-btn');
            if (toggleBtn) {
                toggleBtn.textContent = contentSection.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
            }
        }

        function updateSubcategoryName(catIndex, subcatIndex, newName) {
            topicsData.categories[catIndex].subcategories[subcatIndex].name = newName.trim();
        }

        function deleteSubcategory(catIndex, subcatIndex) {
            const subcat = topicsData.categories[catIndex].subcategories[subcatIndex];
            if (confirm(`Delete subcategory "${subcat.name}" and all its topics?`)) {
                topicsData.categories[catIndex].subcategories.splice(subcatIndex, 1);
                renderCategories();
                showMessage('Subcategory deleted. Don\'t forget to save!', 'success');
            }
        }

        function addTopic(catIndex, subcatIndex) {
            const input = document.getElementById(`new-topic-${catIndex}-${subcatIndex}`);
            const topic = input.value.trim();
            if (!topic) {
                showMessage('Please enter a topic name', 'error');
                return;
            }
            topicsData.categories[catIndex].subcategories[subcatIndex].topics.push(topic);
            input.value = '';
            renderCategories();
            showMessage('Topic added. Don\'t forget to save!', 'success');
        }

        function updateTopic(catIndex, subcatIndex, topicIndex, newValue) {
            topicsData.categories[catIndex].subcategories[subcatIndex].topics[topicIndex] = newValue.trim();
        }

        function deleteTopic(catIndex, subcatIndex, topicIndex) {
            const topic = topicsData.categories[catIndex].subcategories[subcatIndex].topics[topicIndex];
            if (confirm(`Delete topic "${topic}"?`)) {
                topicsData.categories[catIndex].subcategories[subcatIndex].topics.splice(topicIndex, 1);
                renderCategories();
                showMessage('Topic deleted. Don\'t forget to save!', 'success');
            }
        }

        // Legacy topic functions (for categories with direct topics)
        function updateLegacyTopic(catIndex, topicIndex, newValue) {
            if (!topicsData.categories[catIndex].topics) {
                topicsData.categories[catIndex].topics = [];
            }
            topicsData.categories[catIndex].topics[topicIndex] = newValue.trim();
        }

        function deleteLegacyTopic(catIndex, topicIndex) {
            const topic = topicsData.categories[catIndex].topics[topicIndex];
            if (confirm(`Delete topic "${topic}"?`)) {
                topicsData.categories[catIndex].topics.splice(topicIndex, 1);
                renderCategories();
                showMessage('Topic deleted. Don\'t forget to save!', 'success');
            }
        }

        async function saveAll() {
            try {
                const response = await fetch('/api/topics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(topicsData)
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage('‚úÖ Topics saved successfully!', 'success');
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to save'), 'error');
                }
            } catch (error) {
                showMessage('Error saving topics: ' + error.message, 'error');
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message message-${type}`;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Load topics on page load (handled above with settings init)
    </script>
</body>
</html>

